<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAVES VALIDATION SUITE v31.0 | 130 SYSTEMS</title>
    <style>
        :root {
            --cyan: #00ffcc;
            --red: #ff3333;
            --gold: #ffaa00;
            --bg: #050505;
            --glass: rgba(10, 15, 20, 0.95);
            --border: 1px solid rgba(0, 255, 204, 0.2);
            --font-main: "Inter", system-ui, -apple-system, sans-serif;
            --font-mono: 'Courier New', monospace;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; background-color: var(--bg); color: #e0e0e0;
            font-family: var(--font-main); height: 100vh; overflow: hidden;
            display: grid; grid-template-rows: 50px 1fr;
            background: radial-gradient(circle at center, #080808 0%, #000 100%);
        }

        header {
            background: rgba(0,0,0,0.9); border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; font-size: 0.85em; font-weight: 700; letter-spacing: 2px;
            z-index: 100;
        }
        .clock-ref { font-family: var(--font-mono); font-size: 0.9em; color: #666; }
        .clock-live { color: var(--cyan); margin-left: 10px; }

        #workspace {
            display: grid; grid-template-columns: 380px 1fr 350px;
            height: 100%; overflow: hidden;
        }

        .panel {
            background: var(--glass); border-right: var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; z-index: 20;
        }
        .panel-right { border-right: none; border-left: var(--border); }

        h2 { 
            margin: 0 0 10px 0; font-size: 0.75em; color: #888; 
            text-transform: uppercase; letter-spacing: 1px; 
            border-bottom: 1px solid #333; padding-bottom: 5px; 
        }

        #inv-list {
            flex: 1; overflow-y: auto; border: 1px solid #333; background: #000;
            font-family: var(--font-mono); font-size: 0.7em;
        }
        .inv-item {
            padding: 10px 15px; border-bottom: 1px solid #222; cursor: pointer; color: #666; transition: 0.2s;
            display: flex; justify-content: flex-start;
        }
        .inv-item:hover { background: rgba(0, 255, 204, 0.05); color: #fff; }
        .inv-item.active { background: var(--cyan); color: #000; font-weight: bold; }
        .inv-id { color: #444; margin-right: 15px; width: 30px; }
        .inv-item.active .inv-id { color: #000; }

        .input-group { margin-bottom: 5px; }
        label { display: block; font-size: 0.7em; color: #666; margin-bottom: 3px; font-family: var(--font-mono); }
        input, textarea {
            width: 100%; background: #111; border: 1px solid #333; color: var(--cyan);
            padding: 8px; font-family: var(--font-mono); font-size: 0.85em; outline: none; resize: none;
        }
        
        #stage {
            position: relative; display: flex; flex-direction: column;
            padding: 20px; gap: 20px; background: radial-gradient(circle at center, #111 0%, #000 100%);
        }

        .graph-box {
            flex: 1; background: rgba(0,0,0,0.5); border: 1px solid #333;
            position: relative; padding: 0; display: flex; flex-direction: column;
            overflow: hidden;
        }
        .graph-header { position: absolute; top: 10px; left: 10px; font-size: 0.7em; color: var(--cyan); font-weight: bold; z-index: 10;}
        .lock-indicator { position: absolute; top: 10px; right: 10px; font-size: 0.7em; color: #555; font-weight: bold; z-index: 10;}
        
        button {
            width: 100%; padding: 15px; background: rgba(0, 255, 204, 0.05);
            border: 1px solid var(--cyan); color: var(--cyan); font-family: var(--font-main);
            font-weight: 700; letter-spacing: 1px; cursor: pointer; transition: 0.2s;
            text-transform: uppercase; margin-top: 5px;
        }
        button:hover { background: var(--cyan); color: #000; box-shadow: 0 0 20px rgba(0,255,204,0.3); }
        button:disabled { border-color: #333; color: #555; background: transparent; cursor: not-allowed; box-shadow: none; }

        #console {
            height: 200px; background: #000; border: 1px solid #333;
            font-family: var(--font-mono); font-size: 0.7em; color: #888;
            padding: 10px; overflow-y: auto; white-space: pre-wrap; line-height: 1.4;
        }
        .log-cyan { color: var(--cyan); }
        .log-gold { color: var(--gold); }
        .log-err { color: var(--red); }

        #scan-line {
            position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: var(--cyan);
            box-shadow: 0 0 15px var(--cyan); opacity: 0; pointer-events: none; z-index: 5;
            transition: opacity 0.2s;
        }

        canvas { display: block; width: 100%; height: 100%; }
        
        .atom-label {
            position: absolute; color: #fff; font-size: 10px; font-family: sans-serif;
            pointer-events: none; text-shadow: 0 0 3px #000; font-weight: bold;
            opacity: 0; transform: translate(-50%, -50%);
            will-change: transform, opacity;
        }
        .atom-label.visible { opacity: 1; }
    </style>
</head>
<body>

<header>
    <div>GRAVES VALIDATION SUITE <span style="color:#666">// v31.0 - 130 SYSTEMS</span></div>
    <div class="clock-ref">DEUTERIUM REF: <span class="clock-live" id="clock-display">INITIALIZING...</span></div>
</header>

<div id="workspace">
    
    <div class="panel">
        <h2>1. Select System (130 Total)</h2>
        <div id="inv-list"></div>
        
        <h2>2. Composition Data</h2>
        <div class="input-group">
            <label>PRIMARY ELEMENTS</label>
            <input type="text" id="comp-elements" readonly>
        </div>
        <div class="input-group">
            <label>SYSTEM DETAILS</label>
            <textarea id="comp-detail" rows="4" readonly style="color:#aaa;"></textarea>
        </div>
        <div class="input-group">
            <label>LATTICE SYMMETRY</label>
            <input type="text" id="lattice-type" readonly>
        </div>
        <div class="input-group" style="background:#111; border:1px solid #333; padding:10px; margin-top:5px;">
            <label style="color:#666;">WAAM (Weighted Atomic Mass)</label>
            <div id="mass-readout" style="color:#fff; font-family:var(--font-mono); font-size:1.1em; letter-spacing:1px;">--</div>
        </div>
        
        <button id="btn-scan" onclick="app.runScan()" disabled>INITIATE TORSION SCAN</button>
    </div>

    <div id="stage">
        <div class="graph-box" style="flex: 1;">
            <div class="graph-header">HYPERFINE LOCK SCANNER (5.030 - 5.045)</div>
            <div class="lock-indicator" id="lock-indicator">STANDBY</div>
            <canvas id="scanCanvas"></canvas>
            <div id="scan-line"></div>
        </div>

        <div class="graph-box" style="flex: 2; background: #000;" id="atom-container">
            <div class="graph-header">3D ATOMIC LATTICE (LIVE RENDER)</div>
            <canvas id="atomCanvas"></canvas>
        </div>
    </div>

    <div class="panel panel-right">
        <h2>3. Lock Results</h2>
        <div class="input-group">
            <label>UNIQUE LOCK ANGLE</label>
            <input type="text" id="res-angle" readonly style="color:var(--gold); font-weight:bold; font-size:1.2em;">
        </div>
        <div class="input-group">
            <label>RESIDUAL SLACK</label>
            <input type="text" id="res-slack" readonly style="color:var(--cyan);">
        </div>
        
        <h2>4. Validation Log</h2>
        <div id="console"></div>
    </div>

</div>

<script>
/**
 * GRAVES VALIDATION SUITE v31.0
 * Architecture: Singleton Pattern (proven in v18)
 * Systems: 130 total (001-100 metals + 901-930 hydrocarbons)
 */
const app = {
    state: {
        rank: null,
        scanning: false,
        locked: false,
        angle: 0,
        atoms: [],
        time: 0
    },

    massTable: {
        "H": 1.008, "He": 4.002, "Li": 6.94, "Be": 9.012, "B": 10.81, "C": 12.01, "N": 14.007, "O": 15.999, "F": 18.998,
        "Na": 22.99, "Mg": 24.305, "Al": 26.98, "Si": 28.085, "P": 30.97, "S": 32.06, "Cl": 35.45, "K": 39.098, "Ca": 40.078,
        "Sc": 44.956, "Ti": 47.867, "V": 50.942, "Cr": 51.996, "Mn": 54.938, "Fe": 55.845, "Co": 58.933, "Ni": 58.693, "Cu": 63.546, "Zn": 65.38,
        "Ga": 69.723, "Ge": 72.63, "As": 74.92, "Se": 78.96, "Br": 79.904, "Kr": 83.798, "Rb": 85.468, "Sr": 87.62, "Y": 88.906, "Zr": 91.224,
        "Nb": 92.906, "Mo": 95.95, "Tc": 98, "Ru": 101.07, "Rh": 102.91, "Pd": 106.42, "Ag": 107.868, "Cd": 112.41, "In": 114.818, "Sn": 118.71,
        "Sb": 121.76, "Te": 127.6, "I": 126.9, "Xe": 131.29, "Cs": 132.91, "Ba": 137.33, "La": 138.91, "Ce": 140.12, "Pr": 140.91, "Nd": 144.24,
        "Pm": 145, "Sm": 150.36, "Eu": 151.96, "Gd": 157.25, "Tb": 158.93, "Dy": 162.5, "Ho": 164.93, "Er": 167.26, "Tm": 168.93, "Yb": 173.05,
        "Lu": 174.97, "Hf": 178.49, "Ta": 180.948, "W": 183.84, "Re": 186.207, "Os": 190.23, "Ir": 192.217, "Pt": 195.084, "Au": 196.967, "Hg": 200.59,
        "Pb": 207.2, "U": 238.029
    },

    db: {},
    dom: {},

    init: function() {
        console.log("BOOT: Starting Graves Validation Suite v31...");
        
        this.dom = {
            invList: document.getElementById('inv-list'),
            console: document.getElementById('console'),
            scanCanvas: document.getElementById('scanCanvas'),
            atomCanvas: document.getElementById('atomCanvas'),
            scanCtx: document.getElementById('scanCanvas').getContext('2d'),
            atomCtx: document.getElementById('atomCanvas').getContext('2d'),
            atomContainer: document.getElementById('atom-container'),
            scanLine: document.getElementById('scan-line'),
            inputs: {
                elements: document.getElementById('comp-elements'),
                detail: document.getElementById('comp-detail'),
                lattice: document.getElementById('lattice-type'),
                mass: document.getElementById('mass-readout'),
                angle: document.getElementById('res-angle'),
                slack: document.getElementById('res-slack')
            },
            btn: document.getElementById('btn-scan'),
            indicator: document.getElementById('lock-indicator')
        };

        this.buildDB();
        this.populateList();

        var self = this;
        var observer = new ResizeObserver(function() { self.resize(); });
        observer.observe(this.dom.atomContainer);
        
        this.initAtoms();
        this.log("SYSTEM INITIALIZED. 130 SYSTEMS LOADED.", "cyan");
        this.log("LITE 100 + HYDROCARBON PERFECTION 30", "gold");
        this.resize();
        
        requestAnimationFrame(function() { self.loop(); });
        
        setInterval(function() {
            var el = document.getElementById('clock-display');
            if(el) el.innerText = (327.384 + (Math.random()-0.5)*0.0001).toFixed(6) + " MHz";
        }, 100);
    },

    buildDB: function() {
        // Core Metal Systems (001-010)
        this.db["001"] = { name: "Icosahedral Nickel Superalloy", elements: ["Ni","Co","Cr","Al","Ti","Mo","W","Nb"], detail: "High-Temperature Ni-Co-Cr Turbine Blade Alloy. Icosahedral symmetry.", lattice: "Icosahedral", type: "metal" };
        this.db["002"] = { name: "Decagonal Cobalt Superalloy", elements: ["Co","Cr","Ni","W","Al","Ta"], detail: "Naval Armor Co-Cr High-Shear Alloy. Decagonal symmetry.", lattice: "Decagonal", type: "metal" };
        this.db["003"] = { name: "Hypersonic W-Re Leading Edge", elements: ["W","Re","Hf","C"], detail: "Tungsten-Rhenium Extreme Temperature Composite.", lattice: "Icosahedral", type: "metal" };
        this.db["004"] = { name: "Pb-B Radiation Shield", elements: ["Pb","B","C"], detail: "Lead-Boron Carbide Neutron Absorber.", lattice: "Decagonal", type: "metal" };
        this.db["005"] = { name: "Fe-Si-B Metamaterial", elements: ["Fe","Si","B"], detail: "Iron-Silicon-Boron RF Absorption Coating.", lattice: "Pentagonal", type: "metal" };
        this.db["006"] = { name: "Ti-Al-V Quasicrystal", elements: ["Ti","Al","V"], detail: "Deep Submersible Hull Material.", lattice: "Icosahedral", type: "metal" };
        this.db["007"] = { name: "Nb-Hf-Ti Refractory", elements: ["Nb","Hf","Ti"], detail: "Rocket Nozzle Liner Material.", lattice: "Decagonal", type: "metal" };
        this.db["008"] = { name: "Al-Li-Sc Lightweight", elements: ["Al","Li","Sc"], detail: "Satellite Structural Frame Material.", lattice: "Icosahedral", type: "metal" };
        this.db["009"] = { name: "W-U High-Density", elements: ["W","U","Ti"], detail: "Kinetic Penetrator Material.", lattice: "Pentagonal", type: "metal" };
        this.db["010"] = { name: "Cu-Cr-Zr Conductor", elements: ["Cu","Cr","Zr","Ag"], detail: "Railgun Component Material.", lattice: "Decagonal", type: "metal" };

        // Hydrocarbon Perfection Catalysts (901-930)
        var hydrocarbons = [
            {id: "901", mol: "CH4", name: "Methane", carbons: 1},
            {id: "902", mol: "C8H18", name: "Octane", carbons: 8},
            {id: "903", mol: "C3H8", name: "Propane", carbons: 3},
            {id: "904", mol: "C4H10", name: "Butane", carbons: 4},
            {id: "905", mol: "C6H14", name: "Hexane", carbons: 6},
            {id: "906", mol: "C12H26", name: "Dodecane", carbons: 12},
            {id: "907", mol: "C14H30", name: "Tetradecane", carbons: 14},
            {id: "908", mol: "C2H6", name: "Ethane", carbons: 2},
            {id: "909", mol: "C5H12", name: "Pentane", carbons: 5},
            {id: "910", mol: "C7H16", name: "Heptane", carbons: 7},
            {id: "911", mol: "C9H20", name: "Nonane", carbons: 9},
            {id: "912", mol: "C10H22", name: "Decane", carbons: 10},
            {id: "913", mol: "C11H24", name: "Undecane", carbons: 11},
            {id: "914", mol: "C13H28", name: "Tridecane", carbons: 13},
            {id: "915", mol: "C15H32", name: "Pentadecane", carbons: 15},
            {id: "916", mol: "C16H34", name: "Hexadecane", carbons: 16},
            {id: "917", mol: "C18H38", name: "Octadecane", carbons: 18},
            {id: "918", mol: "C20H42", name: "Icosane", carbons: 20},
            {id: "919", mol: "C22H46", name: "Docosane", carbons: 22},
            {id: "920", mol: "C24H50", name: "Tetracosane", carbons: 24},
            {id: "921", mol: "C26H54", name: "Hexacosane", carbons: 26},
            {id: "922", mol: "C28H58", name: "Octacosane", carbons: 28},
            {id: "923", mol: "C30H62", name: "Triacontane", carbons: 30},
            {id: "924", mol: "C17H36", name: "Heptadecane", carbons: 17},
            {id: "925", mol: "C19H40", name: "Nonadecane", carbons: 19},
            {id: "926", mol: "C21H44", name: "Heneicosane", carbons: 21},
            {id: "927", mol: "C23H48", name: "Tricosane", carbons: 23},
            {id: "928", mol: "C25H52", name: "Pentacosane", carbons: 25},
            {id: "929", mol: "C27H56", name: "Heptacosane", carbons: 27},
            {id: "930", mol: "C29H60", name: "Nonacosane", carbons: 29}
        ];

        var self = this;
        hydrocarbons.forEach(function(hc) {
            self.db[hc.id] = {
                name: hc.name + " Perfection (" + hc.mol + ")",
                elements: ["Ir", "Os", "Rh", "B"],
                detail: "Zero-Emission " + hc.name + " Reformation Catalyst. " + hc.carbons + "-carbon chain.",
                lattice: "Icosahedral",
                type: "catalyst",
                molecular: hc.mol,
                carbons: hc.carbons
            };
        });

        // Procedural Fill for 011-100
        var safe = ["C", "Si", "Fe", "Al", "Ti", "Ni", "Cu", "Zn"];
        for(var i = 11; i <= 100; i++) {
            var id = i.toString().padStart(3, '0');
            if(this.db[id]) continue;
            var type = i % 3 === 0 ? "Decagonal" : (i % 3 === 1 ? "Icosahedral" : "Pentagonal");
            this.db[id] = {
                name: "Rank " + id + " System",
                elements: [safe[i % safe.length], safe[(i+1) % safe.length], "Au"],
                detail: "Proprietary Graves-Law Formulation " + id + ". " + type + " Symmetry.",
                lattice: type,
                type: "metal"
            };
        }
    },

    populateList: function() {
        var keys = Object.keys(this.db).sort(function(a,b) { return parseInt(a) - parseInt(b); });
        var self = this;
        keys.forEach(function(k) {
            var d = document.createElement('div');
            d.className = 'inv-item';
            d.dataset.id = k;
            d.innerHTML = '<span class="inv-id">' + k + '</span><span>' + self.db[k].name + '</span>';
            d.onclick = function() { self.selectRank(k); };
            self.dom.invList.appendChild(d);
        });
    },

    resize: function() {
        var sCan = this.dom.scanCanvas;
        var aCan = this.dom.atomCanvas;
        
        sCan.width = sCan.offsetWidth;
        sCan.height = sCan.offsetHeight;
        aCan.width = aCan.offsetWidth;
        aCan.height = aCan.offsetHeight;
        
        this.drawGrid(this.dom.scanCtx);
    },

    selectRank: function(id) {
        if(this.state.scanning) return;
        
        document.querySelectorAll('.inv-item').forEach(function(e) { e.classList.remove('active'); });
        var active = document.querySelector('.inv-item[data-id="' + id + '"]');
        if(active) active.classList.add('active');

        this.state.rank = id;
        var data = this.db[id];
        
        var massData = this.calculateMass(data);
        this.state.angle = massData.angle;
        
        this.dom.inputs.elements.value = data.elements.join(" - ");
        this.dom.inputs.detail.value = data.detail;
        this.dom.inputs.lattice.value = data.lattice;
        this.dom.inputs.mass.innerText = massData.avg.toFixed(3) + " g/mol";
        
        this.state.locked = false;
        this.state.scanning = false;
        this.dom.btn.disabled = false;
        this.dom.btn.innerText = "INITIATE TORSION SCAN";
        this.dom.indicator.innerText = "READY";
        this.dom.indicator.style.color = "#555";
        this.dom.inputs.angle.value = "--";
        this.dom.inputs.slack.value = "--";
        this.dom.scanLine.style.opacity = 0;

        this.updateAtomTargets(data.lattice);
        this.clearLabels();
        this.drawGrid(this.dom.scanCtx);
        
        this.log("LOADED RANK " + id + ": " + data.name);
        this.log("TARGET ANGLE: " + massData.angle.toFixed(6));
    },

    calculateMass: function(data) {
        var BASE_ANGLE = 5.0372;
        var shift = 0;
        var avg = 50.0;
        var self = this;
        
        if(data.type === "catalyst" && data.molecular) {
            // Molecular Weight Tuning for Catalysts
            var molWeight = 0;
            if (data.molecular === "CH4") molWeight = 16.04;
            else if (data.molecular === "C2H6") molWeight = 30.07;
            else if (data.molecular === "C3H8") molWeight = 44.1;
            else if (data.molecular === "C4H10") molWeight = 58.12;
            else if (data.molecular === "C5H12") molWeight = 72.15;
            else if (data.molecular === "C6H14") molWeight = 86.18;
            else if (data.molecular === "C7H16") molWeight = 100.2;
            else if (data.molecular === "C8H18") molWeight = 114.23;
            else if (data.molecular === "C9H20") molWeight = 128.26;
            else if (data.molecular === "C10H22") molWeight = 142.29;
            else if (data.molecular === "C11H24") molWeight = 156.31;
            else if (data.molecular === "C12H26") molWeight = 170.33;
            else if (data.molecular === "C13H28") molWeight = 184.36;
            else if (data.molecular === "C14H30") molWeight = 198.39;
            else if (data.molecular === "C15H32") molWeight = 212.42;
            else if (data.molecular === "C16H34") molWeight = 226.44;
            else if (data.molecular === "C17H36") molWeight = 240.47;
            else if (data.molecular === "C18H38") molWeight = 254.49;
            else if (data.molecular === "C19H40") molWeight = 268.52;
            else if (data.molecular === "C20H42") molWeight = 282.55;
            else if (data.molecular === "C21H44") molWeight = 296.57;
            else if (data.molecular === "C22H46") molWeight = 310.6;
            else if (data.molecular === "C23H48") molWeight = 324.63;
            else if (data.molecular === "C24H50") molWeight = 338.65;
            else if (data.molecular === "C25H52") molWeight = 352.68;
            else if (data.molecular === "C26H54") molWeight = 366.71;
            else if (data.molecular === "C27H56") molWeight = 380.73;
            else if (data.molecular === "C28H58") molWeight = 394.76;
            else if (data.molecular === "C29H60") molWeight = 408.79;
            else if (data.molecular === "C30H62") molWeight = 422.81;
            else molWeight = 100.0;
            
            // Heavier molecules require NEGATIVE shift (tighter lattice)
            // Lighter molecules require POSITIVE shift (open lattice)
            shift = (100 - molWeight) * 0.00002;
            avg = molWeight;
        } else {
            // Standard Atomic Mass Averaging for Metals
            var total = 0, count = 0;
            data.elements.forEach(function(el) {
                var m = self.massTable[el];
                if(m) { total += m; count++; }
            });
            avg = count > 0 ? total / count : 50.0;
            var diff = avg - 77.1;
            shift = diff * 0.00005;
        }
        
        // Lattice Geometry Correction
        if(data.lattice === "Pentagonal") shift += 0.0001;
        else if(data.lattice === "Decagonal") shift -= 0.0001;
        
        // Clamp to physics limits
        if(shift > 0.007) shift = 0.007;
        if(shift < -0.007) shift = -0.007;
        
        return { avg: avg, angle: parseFloat((BASE_ANGLE + shift).toFixed(6)) };
    },

    runScan: function() {
        if(!this.state.rank) return;
        
        this.state.scanning = true;
        this.dom.btn.disabled = true;
        this.dom.indicator.innerText = "SCANNING...";
        this.dom.indicator.style.color = "var(--cyan)";
        this.dom.scanLine.style.opacity = 1;
        
        this.log("SCAN INITIATED...", "cyan");

        var x = 0;
        var w = this.dom.scanCanvas.width;
        var h = this.dom.scanCanvas.height;
        var ctx = this.dom.scanCtx;
        var self = this;
        
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, w, h);
        this.drawGrid(ctx);

        var timer = setInterval(function() {
            x += 3;
            self.dom.scanLine.style.left = x + "px";
            
            var pct = x / w;
            var currentAngle = 5.030 + (pct * 0.015);
            var dist = Math.abs(currentAngle - self.state.angle);
            
            var energy = 1 - Math.min(1, Math.pow(dist * 300, 2));
            var yPos = h * 0.15 + ((1 - energy) * (h * 0.7));
            
            ctx.fillStyle = dist < 0.0005 ? "#fff" : "#ff3333";
            ctx.fillRect(x, yPos, 2, 2);
            
            if(x >= w) {
                clearInterval(timer);
                self.finishLock();
            }
        }, 10);
    },

    finishLock: function() {
        this.state.scanning = false;
        this.state.locked = true;
        this.dom.btn.disabled = false;
        this.dom.btn.innerText = "SCAN COMPLETE";
        this.dom.scanLine.style.opacity = 0;
        
        this.dom.indicator.innerText = "LOCKED";
        this.dom.indicator.style.color = "var(--gold)";
        this.dom.inputs.angle.value = this.state.angle.toFixed(6);
        this.dom.inputs.slack.value = "0.000 nm (PERFECT)";
        
        this.log("LOCK ACQUIRED AT " + this.state.angle.toFixed(6), "gold");
        this.createLabels();
    },

    initAtoms: function() {
        this.state.atoms = [];
        for(var i = 0; i < 60; i++) {
            this.state.atoms.push({
                x: (Math.random() - 0.5) * 300,
                y: (Math.random() - 0.5) * 300,
                z: (Math.random() - 0.5) * 300,
                tx: 0, ty: 0, tz: 0
            });
        }
    },

    updateAtomTargets: function(type) {
        var phi = 1.6180339887;
        var t = [];
        var s = 90;

        if(type === "Decagonal") {
            for(var k = 0; k < 5; k++) {
                var y = (k - 2) * 40;
                for(var j = 0; j < 10; j++) {
                    var th = (j / 10) * Math.PI * 2;
                    t.push({ x: Math.cos(th) * s, y: y, z: Math.sin(th) * s });
                }
            }
        } else if(type === "Pentagonal") {
            for(var i = 0; i < 60; i++) {
                var r = (i / 60) * s * 1.2;
                var th = i * (Math.PI * 2 / 5);
                t.push({ x: Math.cos(th) * r, y: (i - 30) * 3, z: Math.sin(th) * r });
            }
        } else {
            var v = [
                [0, 1, phi], [0, -1, phi], [0, 1, -phi], [0, -1, -phi],
                [1, phi, 0], [-1, phi, 0], [1, -phi, 0], [-1, -phi, 0],
                [phi, 0, 1], [-phi, 0, 1], [phi, 0, -1], [-phi, 0, -1]
            ];
            v.forEach(function(p) { t.push({ x: p[0] * s, y: p[1] * s, z: p[2] * s }); });
            while(t.length < 60) {
                var th = Math.random() * Math.PI * 2;
                var ph = Math.random() * Math.PI;
                t.push({
                    x: Math.sin(ph) * Math.cos(th) * s * 0.7,
                    y: Math.cos(ph) * s * 0.7,
                    z: Math.sin(ph) * Math.sin(th) * s * 0.7
                });
            }
        }
        
        this.state.atoms.forEach(function(a, i) {
            var target = t[i % t.length];
            a.tx = target.x;
            a.ty = target.y;
            a.tz = target.z;
        });
    },

    loop: function() {
        this.state.time += 0.02;
        var ctx = this.dom.atomCtx;
        var w = ctx.canvas.width;
        var h = ctx.canvas.height;
        
        ctx.clearRect(0, 0, w, h);
        
        if(w === 0 || h === 0) {
            var self = this;
            requestAnimationFrame(function() { self.loop(); });
            return;
        }

        var cx = w / 2;
        var cy = h / 2 + 50;
        
        var locked = this.state.locked;
        var rot = locked ? this.state.time * 0.1 : this.state.time * 0.5;
        
        var renderList = [];
        var self = this;
        
        this.state.atoms.forEach(function(a, i) {
            var noise = locked ? 0 : Math.sin(self.state.time + i) * 40;
            a.x += (a.tx - a.x) * 0.05;
            a.y += (a.ty - a.y) * 0.05;
            a.z += (a.tz - a.z) * 0.05;
            
            var dx = a.x + noise;
            var dy = a.y + noise;
            var dz = a.z + noise;

            var x1 = dx * Math.cos(rot) - dz * Math.sin(rot);
            var z1 = dx * Math.sin(rot) + dz * Math.cos(rot);
            
            var scale = 400 / (400 + z1 + 500);
            var px = cx + x1 * scale;
            var py = cy + dy * scale;
            
            renderList.push({ x: px, y: py, z: z1, s: scale, i: i, el: self.getElement(i) });
        });
        
        renderList.sort(function(a, b) { return b.z - a.z; });

        ctx.strokeStyle = locked ? "rgba(0, 255, 204, 0.2)" : "rgba(255, 50, 50, 0.3)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(var i = 0; i < renderList.length; i++) {
            for(var j = i + 1; j < renderList.length; j++) {
                var d = Math.hypot(renderList[i].x - renderList[j].x, renderList[i].y - renderList[j].y);
                if(d < 60 * renderList[i].s) {
                    ctx.moveTo(renderList[i].x, renderList[i].y);
                    ctx.lineTo(renderList[j].x, renderList[j].y);
                }
            }
        }
        ctx.stroke();

        renderList.forEach(function(p) {
            var color = self.getColor(p.el);
            var size = locked ? 4 * p.s : 3 * p.s;
            
            ctx.fillStyle = locked ? color : "#fff";
            
            if(!locked) {
                ctx.shadowColor = "#f00";
                ctx.shadowBlur = 10;
            } else {
                ctx.shadowBlur = 0;
            }
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
            ctx.fill();
            
            if(locked) {
                var lbl = document.getElementById('lbl-' + p.i);
                if(lbl) {
                    lbl.style.transform = 'translate(' + p.x + 'px, ' + p.y + 'px)';
                }
            }
        });

        requestAnimationFrame(function() { self.loop(); });
    },

    getElement: function(i) {
        if(!this.state.rank) return "Au";
        var els = this.db[this.state.rank].elements;
        return els[i % els.length];
    },

    getColor: function(el) {
        var map = {
            "Au": "#FFD700", "Ni": "#00FF00", "Co": "#0000FF", "Cr": "#888888", 
            "Al": "#DDDDDD", "Ti": "#AAAAAA", "W": "#555555", "Pb": "#666666",
            "Fe": "#AA4444", "Si": "#00FFFF", "Cu": "#FF8800", "Zn": "#7C7C7C",
            "C": "#444444", "B": "#FF66FF", "Re": "#AAAA00", "Hf": "#CCCCCC",
            "Ir": "#EEEEFF", "Os": "#AADDFF", "Rh": "#FFDDAA", "V": "#FFAA77",
            "Li": "#CCAAFF", "Sc": "#FFCCAA", "U": "#66FF66", "Ag": "#DDDDDD",
            "Mo": "#BBBBBB", "Nb": "#99CCFF", "Ta": "#AAFFAA", "H": "#FFFFFF"
        };
        return map[el] || "#ffffff";
    },

    drawGrid: function(ctx) {
        ctx.strokeStyle = "#222";
        ctx.lineWidth = 1;
        ctx.beginPath();
        var w = ctx.canvas.width;
        var h = ctx.canvas.height;
        for(var i = 0; i <= 10; i++) {
            ctx.moveTo(i * w / 10, 0);
            ctx.lineTo(i * w / 10, h);
            ctx.moveTo(0, i * h / 10);
            ctx.lineTo(w, i * h / 10);
        }
        ctx.stroke();
    },
    
    createLabels: function() {
        this.clearLabels();
        if(!this.state.rank) return;
        
        var els = this.db[this.state.rank].elements;
        var self = this;
        this.state.atoms.forEach(function(a, i) {
            var el = els[i % els.length];
            var d = document.createElement('div');
            d.className = 'atom-label visible';
            d.id = 'lbl-' + i;
            d.innerText = el;
            d.style.color = self.getColor(el);
            self.dom.atomContainer.appendChild(d);
        });
    },
    
    clearLabels: function() {
        var labels = document.querySelectorAll('.atom-label');
        for(var i = 0; i < labels.length; i++) {
            labels[i].remove();
        }
    },

    log: function(msg, type) {
        var d = document.createElement('div');
        d.innerHTML = '> ' + msg;
        if(type === 'cyan') d.className = 'log-cyan';
        else if(type === 'gold') d.className = 'log-gold';
        else if(type === 'err') d.className = 'log-err';
        this.dom.console.appendChild(d);
        this.dom.console.scrollTop = this.dom.console.scrollHeight;
    }
};

// Boot
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { app.init(); });
} else {
    app.init();
}
</script>
</body>
</html>
