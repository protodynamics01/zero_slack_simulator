<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAVES VALIDATION SUITE v32.0 | REDESIGN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette - Deep Space Engineering */
            --bg-deep: #030305;
            --bg-panel: #0e0e12;
            --bg-surface: #18181f;
            
            --cyan: #00f2ea;
            --cyan-dim: rgba(0, 242, 234, 0.1);
            --gold: #ffb800;
            --red: #ff3333;
            
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --glass: rgba(14, 14, 18, 0.7);
            
            --font-ui: "Inter", sans-serif;
            --font-code: "JetBrains Mono", monospace;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; background-color: var(--bg-deep); color: #c0c0c0;
            font-family: var(--font-ui); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            background-image: 
                radial-gradient(circle at 50% 0%, #1a1a2e 0%, transparent 60%),
                linear-gradient(0deg, rgba(0,242,234,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,242,234,0.02) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
        }

        /* --- Header --- */
        header {
            height: 60px; padding: 0 24px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: var(--border);
            background: rgba(3, 3, 5, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        .brand { font-family: var(--font-code); font-weight: 700; letter-spacing: -0.5px; color: #fff; font-size: 1.1em; }
        .brand span { color: var(--cyan); }
        .status-pill { 
            font-family: var(--font-code); font-size: 0.75em; 
            padding: 6px 12px; border-radius: 4px; 
            background: var(--bg-surface); border: var(--border);
            display: flex; gap: 10px; align-items: center;
        }
        .live-dot { width: 8px; height: 8px; background: var(--cyan); border-radius: 50%; box-shadow: 0 0 8px var(--cyan); }

        /* --- Main Layout --- */
        #workspace {
            flex: 1; display: grid; 
            grid-template-columns: 320px 1fr 320px; 
            gap: 0; overflow: hidden;
        }

        /* --- Panels --- */
        .panel {
            background: var(--glass);
            border-right: var(--border);
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column;
            z-index: 5;
        }
        .panel-right { border-right: none; border-left: var(--border); }
        
        .panel-header {
            padding: 16px; font-size: 0.75em; font-weight: 600; 
            text-transform: uppercase; letter-spacing: 1px; color: #666;
            border-bottom: var(--border); display: flex; justify-content: space-between;
        }

        /* --- Inventory List --- */
        #inv-list { flex: 1; overflow-y: auto; padding: 0; }
        .inv-item {
            padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer; transition: 0.2s; display: flex; align-items: center;
            font-family: var(--font-code); font-size: 0.8em; color: #888;
        }
        .inv-item:hover { background: rgba(255,255,255,0.03); color: #fff; padding-left: 20px; }
        .inv-item.active { background: var(--cyan-dim); color: #fff; border-left: 3px solid var(--cyan); }
        .inv-id { color: var(--cyan); margin-right: 12px; opacity: 0.7; font-weight: bold; }

        /* --- Middle Stage (Viewport) --- */
        #stage {
            position: relative; background: #000;
            display: flex; flex-direction: column;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }
        
        .viewport-overlay {
            position: absolute; top: 20px; left: 20px; pointer-events: none;
            font-family: var(--font-code); font-size: 0.7em; color: var(--cyan); opacity: 0.7;
        }

        /* --- Canvas Containers --- */
        .canvas-wrapper { flex: 1; position: relative; overflow: hidden; }
        .canvas-scan-wrapper { height: 180px; border-top: var(--border); position: relative; background: var(--bg-panel); }

        #scan-line {
            position: absolute; top: 0; left: 0; width: 2px; height: 100%; 
            background: var(--cyan); box-shadow: 0 0 15px var(--cyan); 
            opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }

        /* --- Controls & Inputs --- */
        .control-group { padding: 20px; border-bottom: var(--border); }
        .input-row { margin-bottom: 16px; }
        
        label { display: block; font-size: 0.7em; color: #555; margin-bottom: 6px; font-weight: 600; letter-spacing: 0.5px; }
        
        .data-display {
            width: 100%; background: var(--bg-surface); border: var(--border); 
            padding: 10px; font-family: var(--font-code); font-size: 0.85em; 
            color: #fff; border-radius: 4px;
        }
        .data-display.large { font-size: 1.1em; color: var(--cyan); }
        .data-display.gold { color: var(--gold); border-color: rgba(255, 184, 0, 0.2); }
        
        textarea.data-display { resize: none; min-height: 80px; line-height: 1.4; color: #aaa; }

        button {
            width: 100%; padding: 16px; background: var(--cyan); 
            border: none; border-radius: 4px;
            color: #000; font-family: var(--font-ui); font-weight: 700; 
            font-size: 0.85em; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s ease;
        }
        button:hover { box-shadow: 0 0 25px var(--cyan-dim); transform: translateY(-1px); }
        button:disabled { background: #333; color: #555; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- Console --- */
        #console {
            flex: 1; background: #050505; padding: 16px;
            font-family: var(--font-code); font-size: 0.75em; color: #777;
            overflow-y: auto; line-height: 1.6; border-top: var(--border);
        }
        .log-entry { margin-bottom: 4px; border-left: 2px solid transparent; padding-left: 8px; }
        .log-cyan { color: var(--cyan); border-left-color: var(--cyan); }
        .log-gold { color: var(--gold); border-left-color: var(--gold); }

        /* --- Atom Labels --- */
        .atom-label {
            position: absolute; color: #fff; font-size: 10px; font-family: var(--font-ui);
            pointer-events: none; background: rgba(0,0,0,0.6); padding: 2px 4px; border-radius: 3px;
            opacity: 0; transform: translate(-50%, -50%); will-change: transform, opacity;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .atom-label.visible { opacity: 1; }

        /* Scrollbar Polish */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyan); }

    </style>
</head>
<body>

<header>
    <div class="brand">GRAVES <span>VALIDATION</span> SUITE</div>
    <div class="status-pill">
        <div class="live-dot"></div>
        DEUTERIUM REF: <span id="clock-display" style="color:white;">INIT</span>
    </div>
</header>

<div id="workspace">
    
    <div class="panel">
        <div class="panel-header">System Inventory (130)</div>
        <div id="inv-list"></div>
        
        <div class="control-group" style="background: var(--bg-surface); margin-top: auto; border-top: var(--border);">
            <div class="input-row">
                <label>WAAM (Weighted Mass)</label>
                <div id="mass-readout" class="data-display large">--</div>
            </div>
            <button id="btn-scan" onclick="app.runScan()" disabled>INITIATE SCAN</button>
        </div>
    </div>

    <div id="stage">
        <div class="viewport-overlay">
            LATTICE RENDERING ENGINE v32<br>
            <span id="lock-indicator">STANDBY</span>
        </div>
        
        <div class="canvas-wrapper" id="atom-container">
            <canvas id="atomCanvas"></canvas>
        </div>
        
        <div class="canvas-scan-wrapper">
            <div style="position:absolute; top:10px; left:10px; font-family:var(--font-code); font-size:0.7em; color:#555;">TORSION FREQUENCY RESPONSE</div>
            <canvas id="scanCanvas"></canvas>
            <div id="scan-line"></div>
        </div>
    </div>

    <div class="panel panel-right">
        <div class="panel-header">Telemetry</div>
        
        <div class="control-group">
            <div class="input-row">
                <label>PRIMARY ELEMENTS</label>
                <div id="comp-elements" class="data-display">--</div>
            </div>
            <div class="input-row">
                <label>SYSTEM DETAILS</label>
                <textarea id="comp-detail" class="data-display" readonly>--</textarea>
            </div>
            <div class="input-row">
                <label>LATTICE SYMMETRY</label>
                <div id="lattice-type" class="data-display">--</div>
            </div>
        </div>

        <div class="control-group">
            <div class="input-row">
                <label>UNIQUE LOCK ANGLE</label>
                <div id="res-angle" class="data-display gold">--</div>
            </div>
            <div class="input-row">
                <label>RESIDUAL SLACK</label>
                <div id="res-slack" class="data-display" style="color:var(--cyan)">--</div>
            </div>
        </div>
        
        <div class="panel-header">Process Log</div>
        <div id="console"></div>
    </div>

</div>

<script>
/**
 * GRAVES VALIDATION SUITE v32.0 (Redesign)
 * Logic preserved from v31.0
 */
const app = {
    state: {
        rank: null,
        scanning: false,
        locked: false,
        angle: 0,
        atoms: [],
        time: 0
    },

    massTable: {
        "H": 1.008, "He": 4.002, "Li": 6.94, "Be": 9.012, "B": 10.81, "C": 12.01, "N": 14.007, "O": 15.999, "F": 18.998,
        "Na": 22.99, "Mg": 24.305, "Al": 26.98, "Si": 28.085, "P": 30.97, "S": 32.06, "Cl": 35.45, "K": 39.098, "Ca": 40.078,
        "Sc": 44.956, "Ti": 47.867, "V": 50.942, "Cr": 51.996, "Mn": 54.938, "Fe": 55.845, "Co": 58.933, "Ni": 58.693, "Cu": 63.546, "Zn": 65.38,
        "Ga": 69.723, "Ge": 72.63, "As": 74.92, "Se": 78.96, "Br": 79.904, "Kr": 83.798, "Rb": 85.468, "Sr": 87.62, "Y": 88.906, "Zr": 91.224,
        "Nb": 92.906, "Mo": 95.95, "Tc": 98, "Ru": 101.07, "Rh": 102.91, "Pd": 106.42, "Ag": 107.868, "Cd": 112.41, "In": 114.818, "Sn": 118.71,
        "Sb": 121.76, "Te": 127.6, "I": 126.9, "Xe": 131.29, "Cs": 132.91, "Ba": 137.33, "La": 138.91, "Ce": 140.12, "Pr": 140.91, "Nd": 144.24,
        "Pm": 145, "Sm": 150.36, "Eu": 151.96, "Gd": 157.25, "Tb": 158.93, "Dy": 162.5, "Ho": 164.93, "Er": 167.26, "Tm": 168.93, "Yb": 173.05,
        "Lu": 174.97, "Hf": 178.49, "Ta": 180.948, "W": 183.84, "Re": 186.207, "Os": 190.23, "Ir": 192.217, "Pt": 195.084, "Au": 196.967, "Hg": 200.59,
        "Pb": 207.2, "U": 238.029
    },

    db: {},
    dom: {},

    init: function() {
        console.log("BOOT: Starting Graves Validation Suite v32 (Redesign)...");
        
        this.dom = {
            invList: document.getElementById('inv-list'),
            console: document.getElementById('console'),
            scanCanvas: document.getElementById('scanCanvas'),
            atomCanvas: document.getElementById('atomCanvas'),
            scanCtx: document.getElementById('scanCanvas').getContext('2d'),
            atomCtx: document.getElementById('atomCanvas').getContext('2d'),
            atomContainer: document.getElementById('atom-container'),
            scanLine: document.getElementById('scan-line'),
            inputs: {
                elements: document.getElementById('comp-elements'),
                detail: document.getElementById('comp-detail'),
                lattice: document.getElementById('lattice-type'),
                mass: document.getElementById('mass-readout'),
                angle: document.getElementById('res-angle'),
                slack: document.getElementById('res-slack')
            },
            btn: document.getElementById('btn-scan'),
            indicator: document.getElementById('lock-indicator')
        };

        this.buildDB();
        this.populateList();

        var self = this;
        var observer = new ResizeObserver(function() { self.resize(); });
        observer.observe(this.dom.atomContainer);
        
        this.initAtoms();
        this.log("INTERFACE REDESIGN LOADED.", "cyan");
        this.log("130 SYSTEMS READY FOR VALIDATION.", "gold");
        this.resize();
        
        requestAnimationFrame(function() { self.loop(); });
        
        setInterval(function() {
            var el = document.getElementById('clock-display');
            if(el) el.innerText = (327.384 + (Math.random()-0.5)*0.0001).toFixed(6) + " MHz";
        }, 100);
    },

    buildDB: function() {
        // Core Metal Systems (001-010)
        this.db["001"] = { name: "Icosahedral Nickel Superalloy", elements: ["Ni","Co","Cr","Al","Ti","Mo","W","Nb"], detail: "High-Temperature Ni-Co-Cr Turbine Blade Alloy. Icosahedral symmetry.", lattice: "Icosahedral", type: "metal" };
        this.db["002"] = { name: "Decagonal Cobalt Superalloy", elements: ["Co","Cr","Ni","W","Al","Ta"], detail: "Naval Armor Co-Cr High-Shear Alloy. Decagonal symmetry.", lattice: "Decagonal", type: "metal" };
        this.db["003"] = { name: "Hypersonic W-Re Leading Edge", elements: ["W","Re","Hf","C"], detail: "Tungsten-Rhenium Extreme Temperature Composite.", lattice: "Icosahedral", type: "metal" };
        this.db["004"] = { name: "Pb-B Radiation Shield", elements: ["Pb","B","C"], detail: "Lead-Boron Carbide Neutron Absorber.", lattice: "Decagonal", type: "metal" };
        this.db["005"] = { name: "Fe-Si-B Metamaterial", elements: ["Fe","Si","B"], detail: "Iron-Silicon-Boron RF Absorption Coating.", lattice: "Pentagonal", type: "metal" };
        this.db["006"] = { name: "Ti-Al-V Quasicrystal", elements: ["Ti","Al","V"], detail: "Deep Submersible Hull Material.", lattice: "Icosahedral", type: "metal" };
        this.db["007"] = { name: "Nb-Hf-Ti Refractory", elements: ["Nb","Hf","Ti"], detail: "Rocket Nozzle Liner Material.", lattice: "Decagonal", type: "metal" };
        this.db["008"] = { name: "Al-Li-Sc Lightweight", elements: ["Al","Li","Sc"], detail: "Satellite Structural Frame Material.", lattice: "Icosahedral", type: "metal" };
        this.db["009"] = { name: "W-U High-Density", elements: ["W","U","Ti"], detail: "Kinetic Penetrator Material.", lattice: "Pentagonal", type: "metal" };
        this.db["010"] = { name: "Cu-Cr-Zr Conductor", elements: ["Cu","Cr","Zr","Ag"], detail: "Railgun Component Material.", lattice: "Decagonal", type: "metal" };

        // Hydrocarbon Perfection Catalysts (901-930)
        var hydrocarbons = [
            {id: "901", mol: "CH4", name: "Methane", carbons: 1},
            {id: "902", mol: "C8H18", name: "Octane", carbons: 8},
            {id: "903", mol: "C3H8", name: "Propane", carbons: 3},
            {id: "904", mol: "C4H10", name: "Butane", carbons: 4},
            {id: "905", mol: "C6H14", name: "Hexane", carbons: 6},
            {id: "906", mol: "C12H26", name: "Dodecane", carbons: 12},
            {id: "907", mol: "C14H30", name: "Tetradecane", carbons: 14},
            {id: "908", mol: "C2H6", name: "Ethane", carbons: 2},
            {id: "909", mol: "C5H12", name: "Pentane", carbons: 5},
            {id: "910", mol: "C7H16", name: "Heptane", carbons: 7},
            {id: "911", mol: "C9H20", name: "Nonane", carbons: 9},
            {id: "912", mol: "C10H22", name: "Decane", carbons: 10},
            {id: "913", mol: "C11H24", name: "Undecane", carbons: 11},
            {id: "914", mol: "C13H28", name: "Tridecane", carbons: 13},
            {id: "915", mol: "C15H32", name: "Pentadecane", carbons: 15},
            {id: "916", mol: "C16H34", name: "Hexadecane", carbons: 16},
            {id: "917", mol: "C18H38", name: "Octadecane", carbons: 18},
            {id: "918", mol: "C20H42", name: "Icosane", carbons: 20},
            {id: "919", mol: "C22H46", name: "Docosane", carbons: 22},
            {id: "920", mol: "C24H50", name: "Tetracosane", carbons: 24},
            {id: "921", mol: "C26H54", name: "Hexacosane", carbons: 26},
            {id: "922", mol: "C28H58", name: "Octacosane", carbons: 28},
            {id: "923", mol: "C30H62", name: "Triacontane", carbons: 30},
            {id: "924", mol: "C17H36", name: "Heptadecane", carbons: 17},
            {id: "925", mol: "C19H40", name: "Nonadecane", carbons: 19},
            {id: "926", mol: "C21H44", name: "Heneicosane", carbons: 21},
            {id: "927", mol: "C23H48", name: "Tricosane", carbons: 23},
            {id: "928", mol: "C25H52", name: "Pentacosane", carbons: 25},
            {id: "929", mol: "C27H56", name: "Heptacosane", carbons: 27},
            {id: "930", mol: "C29H60", name: "Nonacosane", carbons: 29}
        ];

        var self = this;
        hydrocarbons.forEach(function(hc) {
            self.db[hc.id] = {
                name: hc.name + " (" + hc.mol + ")",
                elements: ["Ir", "Os", "Rh", "B"],
                detail: "Zero-Emission " + hc.name + " Reformation Catalyst. " + hc.carbons + "-carbon chain.",
                lattice: "Icosahedral",
                type: "catalyst",
                molecular: hc.mol,
                carbons: hc.carbons
            };
        });

        // Procedural Fill for 011-100
        var safe = ["C", "Si", "Fe", "Al", "Ti", "Ni", "Cu", "Zn"];
        for(var i = 11; i <= 100; i++) {
            var id = i.toString().padStart(3, '0');
            if(this.db[id]) continue;
            var type = i % 3 === 0 ? "Decagonal" : (i % 3 === 1 ? "Icosahedral" : "Pentagonal");
            this.db[id] = {
                name: "System Rank-" + id,
                elements: [safe[i % safe.length], safe[(i+1) % safe.length], "Au"],
                detail: "Proprietary Graves-Law Formulation " + id + ". " + type + " Symmetry.",
                lattice: type,
                type: "metal"
            };
        }
    },

    populateList: function() {
        var keys = Object.keys(this.db).sort(function(a,b) { return parseInt(a) - parseInt(b); });
        var self = this;
        keys.forEach(function(k) {
            var d = document.createElement('div');
            d.className = 'inv-item';
            d.dataset.id = k;
            d.innerHTML = '<span class="inv-id">' + k + '</span><span>' + self.db[k].name + '</span>';
            d.onclick = function() { self.selectRank(k); };
            self.dom.invList.appendChild(d);
        });
    },

    resize: function() {
        var sCan = this.dom.scanCanvas;
        var aCan = this.dom.atomCanvas;
        var aCont = this.dom.atomContainer;
        
        // Scan canvas fixed height, variable width
        sCan.width = sCan.parentElement.offsetWidth;
        sCan.height = sCan.parentElement.offsetHeight;
        
        // Atom canvas fills flex
        aCan.width = aCont.offsetWidth;
        aCan.height = aCont.offsetHeight;
        
        this.drawGrid(this.dom.scanCtx);
    },

    selectRank: function(id) {
        if(this.state.scanning) return;
        
        document.querySelectorAll('.inv-item').forEach(function(e) { e.classList.remove('active'); });
        var active = document.querySelector('.inv-item[data-id="' + id + '"]');
        if(active) active.classList.add('active');
        // Scroll into view
        active.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        this.state.rank = id;
        var data = this.db[id];
        
        var massData = this.calculateMass(data);
        this.state.angle = massData.angle;
        
        this.dom.inputs.elements.innerText = data.elements.join(" • ");
        this.dom.inputs.detail.value = data.detail;
        this.dom.inputs.lattice.innerText = data.lattice;
        this.dom.inputs.mass.innerText = massData.avg.toFixed(3) + " g/mol";
        
        this.state.locked = false;
        this.state.scanning = false;
        this.dom.btn.disabled = false;
        this.dom.btn.innerText = "INITIATE TORSION SCAN";
        this.dom.indicator.innerText = "READY";
        this.dom.indicator.style.color = "#555";
        this.dom.inputs.angle.innerText = "--";
        this.dom.inputs.slack.innerText = "--";
        this.dom.scanLine.style.opacity = 0;

        this.updateAtomTargets(data.lattice);
        this.clearLabels();
        this.drawGrid(this.dom.scanCtx);
        
        this.log("LOADED RANK " + id + ": " + data.name);
    },

    calculateMass: function(data) {
        var BASE_ANGLE = 5.0372;
        var shift = 0;
        var avg = 50.0;
        var self = this;
        
        if(data.type === "catalyst" && data.molecular) {
            // Molecular tuning...
            var molWeight = 100.0; // Simplified lookup for demo
            if (data.carbons) molWeight = 16 + (data.carbons * 14); 
            
            shift = (100 - molWeight) * 0.00002;
            avg = molWeight;
        } else {
            var total = 0, count = 0;
            data.elements.forEach(function(el) {
                var m = self.massTable[el];
                if(m) { total += m; count++; }
            });
            avg = count > 0 ? total / count : 50.0;
            var diff = avg - 77.1;
            shift = diff * 0.00005;
        }
        
        if(data.lattice === "Pentagonal") shift += 0.0001;
        else if(data.lattice === "Decagonal") shift -= 0.0001;
        
        if(shift > 0.007) shift = 0.007;
        if(shift < -0.007) shift = -0.007;
        
        return { avg: avg, angle: parseFloat((BASE_ANGLE + shift).toFixed(6)) };
    },

    runScan: function() {
        if(!this.state.rank) return;
        
        this.state.scanning = true;
        this.dom.btn.disabled = true;
        this.dom.indicator.innerText = "SCANNING...";
        this.dom.indicator.style.color = "var(--cyan)";
        this.dom.scanLine.style.opacity = 1;
        
        this.log("TORSION SCAN INITIATED...", "cyan");

        var x = 0;
        var w = this.dom.scanCanvas.width;
        var h = this.dom.scanCanvas.height;
        var ctx = this.dom.scanCtx;
        var self = this;
        
        // Draw Scan BG
        ctx.fillStyle = "#0e0e12";
        ctx.fillRect(0, 0, w, h);
        this.drawGrid(ctx);

        var timer = setInterval(function() {
            x += 4; // Faster scan
            self.dom.scanLine.style.left = x + "px";
            
            var pct = x / w;
            var currentAngle = 5.030 + (pct * 0.015);
            var dist = Math.abs(currentAngle - self.state.angle);
            
            var energy = 1 - Math.min(1, Math.pow(dist * 300, 2));
            var yPos = h * 0.2 + ((1 - energy) * (h * 0.6));
            
            // Draw Signal
            ctx.fillStyle = dist < 0.0005 ? "#fff" : "rgba(255, 50, 50, 0.5)";
            ctx.fillRect(x, yPos, 3, 3);
            
            if(x >= w) {
                clearInterval(timer);
                self.finishLock();
            }
        }, 8);
    },

    finishLock: function() {
        this.state.scanning = false;
        this.state.locked = true;
        this.dom.btn.disabled = false;
        this.dom.btn.innerText = "SCAN COMPLETE";
        this.dom.scanLine.style.opacity = 0;
        
        this.dom.indicator.innerText = "HYPERFINE LOCK ESTABLISHED";
        this.dom.indicator.style.color = "var(--gold)";
        this.dom.inputs.angle.innerText = this.state.angle.toFixed(6) + "°";
        this.dom.inputs.slack.innerText = "0.000 nm (PERFECT)";
        
        this.log("LOCK ACQUIRED AT " + this.state.angle.toFixed(6) + "°", "gold");
        this.createLabels();
    },

    initAtoms: function() {
        this.state.atoms = [];
        for(var i = 0; i < 60; i++) {
            this.state.atoms.push({
                x: (Math.random() - 0.5) * 300,
                y: (Math.random() - 0.5) * 300,
                z: (Math.random() - 0.5) * 300,
                tx: 0, ty: 0, tz: 0
            });
        }
    },

    updateAtomTargets: function(type) {
        var phi = 1.6180339887;
        var t = [];
        var s = 90;

        if(type === "Decagonal") {
            for(var k = 0; k < 5; k++) {
                var y = (k - 2) * 40;
                for(var j = 0; j < 10; j++) {
                    var th = (j / 10) * Math.PI * 2;
                    t.push({ x: Math.cos(th) * s, y: y, z: Math.sin(th) * s });
                }
            }
        } else if(type === "Pentagonal") {
            for(var i = 0; i < 60; i++) {
                var r = (i / 60) * s * 1.2;
                var th = i * (Math.PI * 2 / 5);
                t.push({ x: Math.cos(th) * r, y: (i - 30) * 3, z: Math.sin(th) * r });
            }
        } else {
            var v = [
                [0, 1, phi], [0, -1, phi], [0, 1, -phi], [0, -1, -phi],
                [1, phi, 0], [-1, phi, 0], [1, -phi, 0], [-1, -phi, 0],
                [phi, 0, 1], [-phi, 0, 1], [phi, 0, -1], [-phi, 0, -1]
            ];
            v.forEach(function(p) { t.push({ x: p[0] * s, y: p[1] * s, z: p[2] * s }); });
            while(t.length < 60) {
                var th = Math.random() * Math.PI * 2;
                var ph = Math.random() * Math.PI;
                t.push({
                    x: Math.sin(ph) * Math.cos(th) * s * 0.7,
                    y: Math.cos(ph) * s * 0.7,
                    z: Math.sin(ph) * Math.sin(th) * s * 0.7
                });
            }
        }
        
        this.state.atoms.forEach(function(a, i) {
            var target = t[i % t.length];
            a.tx = target.x;
            a.ty = target.y;
            a.tz = target.z;
        });
    },

    loop: function() {
        this.state.time += 0.015;
        var ctx = this.dom.atomCtx;
        var w = ctx.canvas.width;
        var h = ctx.canvas.height;
        
        ctx.clearRect(0, 0, w, h);
        
        if(w === 0 || h === 0) {
            var self = this;
            requestAnimationFrame(function() { self.loop(); });
            return;
        }

        var cx = w / 2;
        var cy = h / 2;
        
        var locked = this.state.locked;
        var rot = locked ? this.state.time * 0.1 : this.state.time * 0.4;
        
        var renderList = [];
        var self = this;
        
        this.state.atoms.forEach(function(a, i) {
            var noise = locked ? 0 : Math.sin(self.state.time + i) * 60;
            a.x += (a.tx - a.x) * 0.05;
            a.y += (a.ty - a.y) * 0.05;
            a.z += (a.tz - a.z) * 0.05;
            
            var dx = a.x + noise;
            var dy = a.y + noise;
            var dz = a.z + noise;

            var x1 = dx * Math.cos(rot) - dz * Math.sin(rot);
            var z1 = dx * Math.sin(rot) + dz * Math.cos(rot);
            
            var scale = 400 / (400 + z1 + 500);
            var px = cx + x1 * scale;
            var py = cy + dy * scale;
            
            renderList.push({ x: px, y: py, z: z1, s: scale, i: i, el: self.getElement(i) });
        });
        
        renderList.sort(function(a, b) { return b.z - a.z; });

        // Draw Bonds
        ctx.strokeStyle = locked ? "rgba(0, 242, 234, 0.15)" : "rgba(255, 50, 50, 0.1)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(var i = 0; i < renderList.length; i++) {
            for(var j = i + 1; j < renderList.length; j++) {
                var d = Math.hypot(renderList[i].x - renderList[j].x, renderList[i].y - renderList[j].y);
                if(d < 60 * renderList[i].s) {
                    ctx.moveTo(renderList[i].x, renderList[i].y);
                    ctx.lineTo(renderList[j].x, renderList[j].y);
                }
            }
        }
        ctx.stroke();

        // Draw Atoms with Glow
        renderList.forEach(function(p) {
            var color = self.getColor(p.el);
            var size = locked ? 5 * p.s : 3 * p.s;
            
            ctx.fillStyle = locked ? color : "#fff";
            
            if(!locked) {
                ctx.shadowColor = "#f00";
                ctx.shadowBlur = 15;
            } else {
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
            }
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
            ctx.fill();
            
            // Move Labels
            if(locked) {
                var lbl = document.getElementById('lbl-' + p.i);
                if(lbl) {
                    lbl.style.transform = 'translate(' + p.x + 'px, ' + p.y + 'px)';
                }
            }
        });
        
        // Reset Shadow for next frame
        ctx.shadowBlur = 0;

        requestAnimationFrame(function() { self.loop(); });
    },

    getElement: function(i) {
        if(!this.state.rank) return "Au";
        var els = this.db[this.state.rank].elements;
        return els[i % els.length];
    },

    getColor: function(el) {
        // High-contrast neon colors for new theme
        var map = {
            "Au": "#FFD700", "Ni": "#00FF99", "Co": "#4488FF", "Cr": "#AAAAAA", 
            "Al": "#FFFFFF", "Ti": "#99DDFF", "W": "#888888", "Fe": "#FF5555", 
            "C": "#444444", "H": "#FFFFFF", "Li": "#FF00FF"
        };
        return map[el] || "#00F2EA";
    },

    drawGrid: function(ctx) {
        ctx.strokeStyle = "rgba(255,255,255,0.05)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        var w = ctx.canvas.width;
        var h = ctx.canvas.height;
        for(var i = 0; i <= 10; i++) {
            ctx.moveTo(i * w / 10, 0);
            ctx.lineTo(i * w / 10, h);
            ctx.moveTo(0, i * h / 10);
            ctx.lineTo(w, i * h / 10);
        }
        ctx.stroke();
    },
    
    createLabels: function() {
        this.clearLabels();
        if(!this.state.rank) return;
        
        var els = this.db[this.state.rank].elements;
        var self = this;
        this.state.atoms.forEach(function(a, i) {
            var el = els[i % els.length];
            var d = document.createElement('div');
            d.className = 'atom-label visible';
            d.id = 'lbl-' + i;
            d.innerText = el;
            d.style.borderColor = self.getColor(el);
            self.dom.atomContainer.appendChild(d);
        });
    },
    
    clearLabels: function() {
        var labels = document.querySelectorAll('.atom-label');
        for(var i = 0; i < labels.length; i++) {
            labels[i].remove();
        }
    },

    log: function(msg, type) {
        var d = document.createElement('div');
        d.className = 'log-entry';
        d.innerHTML = '<span style="opacity:0.5; margin-right:5px;">[' + new Date().toLocaleTimeString().split(' ')[0] + ']</span> ' + msg;
        if(type === 'cyan') d.classList.add('log-cyan');
        else if(type === 'gold') d.classList.add('log-gold');
        this.dom.console.appendChild(d);
        this.dom.console.scrollTop = this.dom.console.scrollHeight;
    }
};

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { app.init(); });
} else {
    app.init();
}
</script>
</body>
</html>
