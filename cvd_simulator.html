<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProtoDynamics Advanced Materials Simulator v4.0 (Production)</title>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.167.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.167.1/examples/jsm/"
        }
    }
    </script>

    <style>
        :root {
            --bg-deep: #050510;
            --bg-panel: rgba(20, 20, 35, 0.95);
            --border: #333355;
            --accent-primary: #3a6dff;
            --accent-secondary: #00ffaa;
            --accent-danger: #ff4444;
            --text-primary: #ffffff;
            --text-secondary: #a0a0ba;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Consolas', 'Monaco', monospace;
        }

        body { 
            margin: 0; 
            background: var(--bg-deep); 
            color: var(--text-primary); 
            font-family: var(--font-main); 
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT CONTAINERS --- */
        #viewport { position: relative; width: 100vw; height: 100vh; display: flex; }
        
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            transition: opacity 0.4s ease;
        }

        .interactive { pointer-events: auto; }

        /* --- DASHBOARD HEADER --- */
        #dashboard-header {
            margin-top: 40px; text-align: center; width: 100%; max-width: 960px;
            background: rgba(10, 10, 20, 0.8); border: 1px solid var(--border);
            border-radius: 16px; padding: 30px;
            backdrop-filter: blur(12px); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        #dashboard-header h1 { margin: 0 0 10px 0; font-weight: 200; letter-spacing: 3px; font-size: 2.2rem; text-transform: uppercase; }
        #dashboard-header p { margin: 0; color: var(--text-secondary); font-size: 0.95rem; }

        /* --- NAVIGATION TABS --- */
        #nav-tabs { 
            margin-top: 25px; display: flex; gap: 15px; 
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 12px;
        }

        .nav-btn {
            padding: 12px 30px; background: transparent; border: 1px solid transparent;
            color: var(--text-secondary); cursor: pointer; border-radius: 8px;
            font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-btn.active { 
            background: var(--accent-primary); color: #fff; 
            box-shadow: 0 4px 15px rgba(58, 109, 255, 0.4);
            border-color: rgba(255,255,255,0.2);
        }

        /* --- MATERIAL GRID --- */
        #material-grid {
            margin-top: 25px; width: 90%; max-width: 1400px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
            max-height: 60vh; overflow-y: auto; padding: 10px 20px 40px 20px;
        }

        /* Custom Scrollbar */
        #material-grid::-webkit-scrollbar { width: 8px; }
        #material-grid::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        #material-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        #material-grid::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        .mat-card {
            background: linear-gradient(145deg, #121225, #0a0a15);
            border: 1px solid var(--border); border-radius: 12px;
            padding: 24px; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; overflow: hidden;
        }

        .mat-card:hover { 
            transform: translateY(-8px); 
            border-color: var(--accent-primary);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4); 
        }

        .mat-card h3 { margin: 0 0 8px 0; font-size: 1.1rem; color: #fff; }
        .mat-card .desc { font-size: 0.85rem; color: #888; margin-bottom: 20px; line-height: 1.4; min-height: 38px; }
        .mat-card .badge {
            font-size: 0.7rem; padding: 4px 10px; border-radius: 20px;
            background: rgba(58, 109, 255, 0.15); color: var(--accent-primary);
            border: 1px solid rgba(58, 109, 255, 0.3); font-weight: bold;
        }

        /* --- SIMULATION VIEW (Hidden by default) --- */
        #sim-view {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 100; display: none;
            flex-direction: row; opacity: 0; transition: opacity 0.5s ease;
        }

        #sim-view.visible { opacity: 1; }

        #canvas-container { flex: 1; position: relative; background: #000; overflow: hidden; }

        #control-panel {
            width: 480px; background: var(--bg-panel); 
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 40px; box-shadow: -10px 0 50px rgba(0,0,0,0.7);
            overflow-y: auto; z-index: 101;
        }

        #panel-header { margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        #panel-header h2 { margin: 0; font-size: 1.8rem; letter-spacing: 1px; color: #fff; }
        #panel-header .subtitle { color: var(--accent-primary); font-size: 0.9rem; font-weight: bold; margin-top: 8px; display: block; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .stat-label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: #fff; }

        #console-log {
            background: #080810; border: 1px solid #333; border-radius: 6px;
            padding: 15px; font-family: var(--font-mono); font-size: 0.85rem;
            color: #0f0; height: 200px; overflow-y: auto; margin-bottom: 20px;
            white-space: pre-wrap; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .action-btn {
            background: var(--accent-primary); color: #fff; border: none; padding: 18px;
            border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer;
            letter-spacing: 1px; transition: all 0.3s; width: 100%; text-transform: uppercase;
        }
        .action-btn:hover:not(:disabled) { background: #5a85ff; box-shadow: 0 0 20px rgba(58,109,255,0.6); }
        .action-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        #close-sim {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; transition: 0.3s;
            z-index: 200;
        }
        #close-sim:hover { background: var(--accent-danger); transform: rotate(90deg); }

        /* Results Table */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th { text-align: left; color: #666; font-size: 0.8rem; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .results-table td { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; }
        .val-bad { color: var(--accent-danger); }
        .val-good { color: var(--accent-secondary); font-weight: bold; }

        /* Loader */
        .loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .loader.active { opacity: 1; }
        .loader-text { color: var(--accent-primary); font-size: 1.5rem; letter-spacing: 4px; font-weight: 300; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Mobile Adjustments */
        @media (max-width: 900px) {
            #sim-view { flex-direction: column; }
            #canvas-container { height: 45vh; flex: none; }
            #control-panel { width: 100%; flex: 1; border-left: none; border-top: 1px solid var(--border); padding: 25px; }
        }
    </style>
</head>
<body>

    <div id="ui-layer" class="interactive">
        <div id="dashboard-header">
            <h1>ProtoDynamics <span style="color:var(--accent-primary)">Sim v4.0</span></h1>
            <p>Proprietary Atomic Alignment & Deposition Protocols • USPTO Micro Entity • 2025 Release</p>
            
            <div id="nav-tabs">
                <button class="nav-btn active" data-category="hydro">Hydrocarbons</button>
                <button class="nav-btn" data-category="metal">Metal & Glass</button>
                <button class="nav-btn" data-category="thermal">Quasicrystals</button>
            </div>
        </div>

        <div id="material-grid">
            </div>
    </div>

    <div id="sim-view">
        <div id="canvas-container">
            <div class="loader" id="loader">
                <div class="loader-text">PLASMA IGNITION</div>
                <div style="color: #666; margin-top: 10px; font-size: 0.8rem;">CALIBRATING MAGNETIC FIELD...</div>
            </div>
            <div id="close-sim">&times;</div>
        </div>
        
        <div id="control-panel">
            <div id="panel-header">
                <h2 id="sim-title">Material Name</h2>
                <span id="sim-tool" class="subtitle">TOOL: CVD SYSTEM</span>
            </div>

            <p id="sim-desc" style="color: #aaa; margin-bottom: 25px; line-height: 1.6;">
                Description goes here.
            </p>

            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-label">CURRENT STATE</span>
                    <span id="status-display" class="stat-value" style="color: var(--accent-danger)">DISORDERED</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">EST. YIELD</span>
                    <span id="yield-display" class="stat-value">0%</span>
                </div>
            </div>

            <button id="btn-run" class="action-btn">INITIATE ALIGNMENT SEQUENCE</button>

            <div id="console-log">>> SYSTEM READY.</div>
            <div id="results-area"></div>
        </div>
    </div>

    <script>
        // FULL 30-ITEM DATABASE (NO TRUNCATION)
        const DATABASE = {
            hydro: [
                { id: 901, name: "Methane (CH₄) Perfection", type: "hydro", chainLength: 1, tool: "CVD FirstGen 3000", desc: "Alignment of tetrahedral bond angles to theoretical 109.5° perfection.", process: ["Chamber purge", "CH4 flow 200sccm", "Plasma 800C", "Alignment Pulse", "Harvest"], before: { eff: "32%", soot: "High" }, after: { eff: "72%", soot: "None" } },
                { id: 902, name: "Ethane (C₂H₆) Synthesis", type: "hydro", chainLength: 2, tool: "CVD FirstGen 3000", desc: "C-C bond length stabilization for natural gas optimization.", process: ["Load Precursor", "Ignite Plasma", "RF Stabilization", "Deposition", "Cool"], before: { eff: "33%", impurities: "2%" }, after: { eff: "71%", impurities: "0%" } },
                { id: 903, name: "Propane (C₃H₈) Matrix", type: "hydro", chainLength: 3, tool: "CVD FirstGen 3000", desc: "LPG optimization for high-pressure storage stability.", process: ["Inject C3H8", "Plasma Scrub", "Lattice Lock", "Harvest"], before: { eff: "35%", stability: "Med" }, after: { eff: "73%", stability: "High" } },
                { id: 904, name: "Butane (C₄H₁₀) Align", type: "hydro", chainLength: 4, tool: "CVD FirstGen 3000", desc: "Isomer elimination for pure n-butane combustion.", process: ["Load C4H10", "Heat to 600C", "Align Pulse", "Collect"], before: { eff: "34%", isomer: "Mix" }, after: { eff: "74%", isomer: "Pure" } },
                { id: 905, name: "Pentane (C₅H₁₂) Solvent", type: "hydro", chainLength: 5, tool: "CVD FirstGen 3000", desc: "Laboratory grade solvent purification.", process: ["Vaporize", "Plasma Filter", "Condense"], before: { purity: "98%" }, after: { purity: "99.999%" } },
                { id: 906, name: "Hexane (C₆H₁₄) Structure", type: "hydro", chainLength: 6, tool: "CVD FirstGen 3000", desc: "Linear chain straightening for industrial feedstock.", process: ["Load C6", "Plasma", "Align", "Collect"], before: { eff: "36%" }, after: { eff: "75%" } },
                { id: 907, name: "Heptane (C₇H₁₆) Standard", type: "hydro", chainLength: 7, tool: "CVD FirstGen 3000", desc: "Zero-knock reference fuel creation.", process: ["Load C7", "Plasma", "Align", "Collect"], before: { ron: "0 (Ref)" }, after: { ron: "Perfect 0" } },
                { id: 908, name: "Iso-Octane (C₈H₁₈)", type: "hydro", chainLength: 8, tool: "CVD FirstGen 3000", desc: "The gold standard for gasoline anti-knock properties.", process: ["Load C8", "Plasma", "Branch Align", "Collect"], before: { ron: "100" }, after: { ron: "115+" } },
                { id: 909, name: "Nonane (C₉H₂₀) Dense", type: "hydro", chainLength: 9, tool: "CVD FirstGen 3000", desc: "High energy density kerosene additive.", process: ["Load C9", "Plasma", "Densify", "Collect"], before: { energy: "42MJ" }, after: { energy: "45MJ" } },
                { id: 910, name: "Decane (C₁₀H₂₂) Diesel", type: "hydro", chainLength: 10, tool: "CVD FirstGen 3000", desc: "Cetane number optimization for heavy fuel.", process: ["Load C10", "Plasma", "Align", "Collect"], before: { cetane: "50" }, after: { cetane: "65+" } }
            ],
            metal: [
                { id: 921, name: "Al-6061 Grain Perfect", type: "lattice", structure: "fcc", tool: "PECVD Reactor", desc: "Elimination of grain boundary precipitates in Aluminum.", process: ["Al Vapor", "N2 Shield", "Grain Align", "Cool"], before: { strength: "290MPa" }, after: { strength: "450MPa" } },
                { id: 922, name: "Copper (Cu) Conductive", type: "lattice", structure: "fcc", tool: "PECVD Reactor", desc: "Oxygen-free high conductivity lattice.", process: ["Cu Vapor", "H2 Reduct", "Crystal Grow"], before: { cond: "58 MS/m" }, after: { cond: "62 MS/m" } },
                { id: 923, name: "Steel 316L Lattice", type: "lattice", structure: "bcc", tool: "PECVD Reactor", desc: "Chromium distribution equalization for corrosion immunity.", process: ["Fe-Cr-Ni", "Plasma", "Mix", "Depose"], before: { corr: "Good" }, after: { corr: "Perfect" } },
                { id: 924, name: "Titanium (Ti-64) Alpha", type: "lattice", structure: "hcp", tool: "PECVD Reactor", desc: "Alpha-phase stabilization for aerospace structures.", process: ["Ti Vapor", "Plasma", "Phase Lock"], before: { strength: "950MPa" }, after: { strength: "1200MPa" } },
                { id: 925, name: "Nickel Superalloy", type: "lattice", structure: "fcc", tool: "PECVD Reactor", desc: "Gamma-prime phase precipitation control.", process: ["Ni Vapor", "Plasma", "Precipitate"], before: { temp: "800C" }, after: { temp: "1000C" } },
                { id: 926, name: "Soda-Lime Glass", type: "glass", structure: "amorphous", tool: "PECVD Reactor", desc: "Defect-free amorphous silica network.", process: ["Si+Na+Ca", "Plasma", "Flow", "Anneal"], before: { trans: "90%" }, after: { trans: "99%" } },
                { id: 927, name: "Borosilicate Glass", type: "glass", structure: "amorphous", tool: "PECVD Reactor", desc: "Thermal shock resistant lattice perfection.", process: ["Si+B", "Plasma", "Flow"], before: { shock: "150K" }, after: { shock: "300K" } },
                { id: 928, name: "Fused Quartz", type: "glass", structure: "amorphous", tool: "PECVD Reactor", desc: "UV transmission optimization.", process: ["Pure Si", "O2 Plasma", "Fusion"], before: { uv: "Good" }, after: { uv: "Perfect" } },
                { id: 929, name: "Silver Coating", type: "lattice", structure: "fcc", tool: "PECVD Reactor", desc: "Anti-microbial surface activation.", process: ["Ag Vapor", "Plasma", "Coat"], before: { life: "1 yr" }, after: { life: "10 yrs" } },
                { id: 930, name: "Gold Plating", type: "lattice", structure: "fcc", tool: "PECVD Reactor", desc: "Atomic layer deposition for electronics.", process: ["Au Vapor", "Plasma", "Layer"], before: { thick: "5um" }, after: { thick: "0.5um" } }
            ],
            thermal: [
                { id: 941, name: "Al-Cu-Fe Quasicrystal", type: "quasi", complexity: 1, tool: "MesoScribe Printer", desc: "Icosahedral phase low-friction coating.", process: ["Powder Feed", "Plasma 35kW", "Spray", "Quench"], before: { frict: "0.4" }, after: { frict: "0.05" } },
                { id: 942, name: "Al-Pd-Mn Thermal", type: "quasi", complexity: 1, tool: "MesoScribe Printer", desc: "Thermal barrier coating.", process: ["Powder", "Plasma", "Spray"], before: { cond: "Low" }, after: { cond: "Ultra-Low" } },
                { id: 943, name: "Ti-Zr-Ni Hydrogen", type: "quasi", complexity: 2, tool: "MesoScribe Printer", desc: "Hydrogen storage lattice.", process: ["Powder", "Plasma", "Spray"], before: { store: "1.5%" }, after: { store: "4.0%" } },
                { id: 944, name: "Al-Ni-Co Decagonal", type: "quasi", complexity: 3, tool: "MesoScribe Printer", desc: "Anisotropic directional strength.", process: ["Powder", "Plasma", "Direct"], before: { str: "Iso" }, after: { str: "Aniso" } },
                { id: 945, name: "Zn-Mg-Ho Magnetic", type: "quasi", complexity: 2, tool: "MesoScribe Printer", desc: "Magnetic ordering in quasicrystals.", process: ["Powder", "Plasma", "Spray"], before: { mag: "None" }, after: { mag: "High" } },
                { id: 946, name: "Cd-Yb Binary", type: "quasi", complexity: 1, tool: "MesoScribe Printer", desc: "Stable binary quasicrystal system.", process: ["Powder", "Plasma", "Spray"], before: { stab: "Low" }, after: { stab: "High" } },
                { id: 947, name: "Ag-In-Yb Hybrid", type: "quasi", complexity: 2, tool: "MesoScribe Printer", desc: "Electronic density of states tuning.", process: ["Powder", "Plasma", "Spray"], before: { cond: "Mix" }, after: { cond: "Tuned" } },
                { id: 948, name: "Al-Li-Cu Lightweight", type: "quasi", complexity: 1, tool: "MesoScribe Printer", desc: "Aerospace weight reduction.", process: ["Powder", "Plasma", "Spray"], before: { dens: "2.7" }, after: { dens: "2.4" } },
                { id: 949, name: "Ti-Fe-Si Bio", type: "quasi", complexity: 2, tool: "MesoScribe Printer", desc: "Biocompatible implant coating.", process: ["Powder", "Plasma", "Spray"], before: { bio: "OK" }, after: { bio: "Great" } },
                { id: 950, name: "Al-Co-Ni Ceramic", type: "quasi", complexity: 3, tool: "MesoScribe Printer", desc: "High temperature ceramic-like behavior.", process: ["Powder", "Plasma", "Spray"], before: { melt: "600C" }, after: { melt: "1100C" } }
            ]
        };
        
        // Expose database to module
        window.MAT_DB = DATABASE;
    </script>
  <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- CONFIGURATION ---
        const COLORS = {
            bg: 0x050510,
            atomCarbon: 0x333333,
            atomHydrogen: 0xffffff,
            atomMetal: 0xaaaaaa,
            atomGlass: 0x88ccff,
            bondDefault: 0x555555,
            bondActive: 0x3a6dff,
            defect: 0xff0000,
            perfect: 0x00ff88,
            plasmaCore: 0x3a6dff,
            plasmaOuter: 0x00ffff
        };

        // --- GLOBAL STATE ---
        let scene, camera, renderer, controls;
        let animationFrameId;
        let currentItem = null;
        let isSimulating = false;
        
        // Scene Objects Storage
        let objects = {
            moleculeGroup: null,
            defects: [],
            plasmaSystem: null
        };

        // --- INITIALIZATION ---
        function initApp() {
            initUI();
            init3D();
            window.addEventListener('resize', onResize);
            renderLoop();
        }

        // --- 3D ENGINE ---
        function init3D() {
            const container = document.getElementById('canvas-container');
            
            // Scene Setup
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(COLORS.bg, 0.02);

            // Camera
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 5, 12);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            
            const sun = new THREE.DirectionalLight(0xffffff, 2);
            sun.position.set(10, 10, 10);
            scene.add(sun);
            
            const accent = new THREE.PointLight(COLORS.plasmaCore, 5, 20);
            accent.position.set(-5, 2, -5);
            scene.add(accent);
        }

        function renderLoop() {
            animationFrameId = requestAnimationFrame(renderLoop);
            controls.update();

            const time = Date.now() * 0.001;

            // Animate Defects
            objects.defects.forEach((d, i) => {
                const s = 1 + Math.sin(time * 5 + i) * 0.3;
                d.scale.setScalar(s);
                d.material.emissiveIntensity = 0.5 + Math.sin(time * 10) * 0.5;
            });

            // Animate Plasma
            if (objects.plasmaSystem) {
                objects.plasmaSystem.rotation.y = time * 0.5;
                objects.plasmaSystem.material.uniforms.uTime.value = time;
            }

            renderer.render(scene, camera);
        }

        // --- SCENE GENERATION LOGIC ---
        
        function clearScene() {
            if (objects.moleculeGroup) {
                scene.remove(objects.moleculeGroup);
                objects.moleculeGroup.traverse(o => {
                    if (o.geometry) o.geometry.dispose();
                    if (o.material) o.material.dispose();
                });
                objects.moleculeGroup = null;
            }
            
            objects.defects.forEach(d => {
                scene.remove(d);
                d.geometry.dispose();
                d.material.dispose();
            });
            objects.defects = [];

            if (objects.plasmaSystem) {
                scene.remove(objects.plasmaSystem);
                objects.plasmaSystem.geometry.dispose();
                objects.plasmaSystem.material.dispose();
                objects.plasmaSystem = null;
            }
        }

        function generateScene(item, state = 'before') {
            clearScene();
            const group = new THREE.Group();
            
            // 1. HYDROCARBONS (Dynamic Chain Length)
            if (item.type === 'hydro') {
                const chainLength = item.chainLength || 1;
                const bondLen = 1.5;
                
                // Materials
                const cMat = new THREE.MeshStandardMaterial({ color: COLORS.atomCarbon, roughness: 0.5, metalness: 0.1 });
                const hMat = new THREE.MeshStandardMaterial({ color: COLORS.atomHydrogen, roughness: 0.2 });
                const bMat = new THREE.MeshStandardMaterial({ color: state === 'before' ? COLORS.bondDefault : COLORS.perfect });

                const atomGeo = new THREE.SphereGeometry(0.4, 32, 32);
                const hGeo = new THREE.SphereGeometry(0.25, 16, 16);
                
                // Generate Zig-Zag Backbone
                for (let i = 0; i < chainLength; i++) {
                    const x = (i - chainLength/2) * 1.0;
                    const y = (i % 2 === 0) ? 0.5 : -0.5;
                    const z = 0;

                    // Carbon
                    const atom = new THREE.Mesh(atomGeo, cMat);
                    // Add "jitter" if state is 'before' (Imperfect)
                    if (state === 'before') {
                        atom.position.set(x + (Math.random()-0.5)*0.5, y + (Math.random()-0.5)*0.5, z + (Math.random()-0.5)*0.5);
                    } else {
                        atom.position.set(x, y, z);
                    }
                    group.add(atom);

                    // Hydrogens (Simplified attachment)
                    const h1 = new THREE.Mesh(hGeo, hMat);
                    h1.position.set(0, (i%2===0 ? 1 : -1), 0.8).add(atom.position);
                    group.add(h1);
                    const h2 = new THREE.Mesh(hGeo, hMat);
                    h2.position.set(0, (i%2===0 ? 1 : -1), -0.8).add(atom.position);
                    group.add(h2);

                    // Bonds
                    if (i > 0) {
                        const prevAtom = group.children[group.children.length - 4]; // Hacky lookback
                        const bond = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, bondLen), bMat);
                        const mid = new THREE.Vector3().addVectors(atom.position, prevAtom.position).multiplyScalar(0.5);
                        bond.position.copy(mid);
                        bond.lookAt(atom.position);
                        bond.rotateX(Math.PI/2);
                        bond.scale.y = atom.position.distanceTo(prevAtom.position);
                        group.add(bond);
                    }
                }
            } 
            
            // 2. CRYSTAL LATTICES & GLASS
            else if (item.type === 'lattice' || item.type === 'glass') {
                const isGlass = item.type === 'glass';
                const mat = new THREE.MeshStandardMaterial({
                    color: isGlass ? COLORS.atomGlass : COLORS.atomMetal,
                    roughness: isGlass ? 0.1 : 0.4,
                    metalness: isGlass ? 0.1 : 0.9,
                    transparent: isGlass,
                    opacity: isGlass ? 0.6 : 1.0
                });
                
                const geo = new THREE.SphereGeometry(0.3, 16, 16);
                const size = 2; // 5x5x5 grid
                const spacing = 1.2;

                for (let x = -size; x <= size; x++) {
                    for (let y = -size; y <= size; y++) {
                        for (let z = -size; z <= size; z++) {
                            // Culling for shape (sphere-ish)
                            if (x*x + y*y + z*z > size*size + 1) continue;

                            const atom = new THREE.Mesh(geo, mat);
                            
                            let posX = x * spacing;
                            let posY = y * spacing;
                            let posZ = z * spacing;

                            // Disorder Logic
                            if (state === 'before' || isGlass) {
                                const noise = isGlass ? 0.4 : 0.3; // Glass is naturally disordered
                                posX += (Math.random()-0.5) * noise;
                                posY += (Math.random()-0.5) * noise;
                                posZ += (Math.random()-0.5) * noise;
                            }
                            
                            // Perfect state for glass = uniform spacing? No, glass is amorphous.
                            // But for "Glass Perfection" we remove bubbles/defects.
                            
                            atom.position.set(posX, posY, posZ);
                            group.add(atom);
                        }
                    }
                }
            }

            // 3. QUASICRYSTALS (Complex Geometry)
            else if (item.type === 'quasi') {
                const complexity = item.complexity || 1;
                const mat = new THREE.MeshStandardMaterial({
                    color: 0xff00ff, roughness: 0.2, metalness: 0.8,
                    flatShading: true
                });

                const geo = new THREE.IcosahedronGeometry(3, complexity);
                const mesh = new THREE.Mesh(geo, mat);
                
                if (state === 'before') {
                    // Distort vertices
                    const pos = geo.attributes.position;
                    for(let i=0; i<pos.count; i++){
                        pos.setXYZ(i, pos.getX(i)+(Math.random()-0.5), pos.getY(i)+(Math.random()-0.5), pos.getZ(i));
                    }
                    geo.computeVertexNormals();
                }

                group.add(mesh);
                
                // Wireframe shell
                const wire = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.2 }));
                group.add(wire);
            }

            // ADD DEFECTS (Red spheres) if 'before'
            if (state === 'before') {
                const defectCount = item.type === 'hydro' ? 3 : 10;
                const range = 4;
                const defMat = new THREE.MeshStandardMaterial({ color: COLORS.defect, emissive: COLORS.defect, emissiveIntensity: 0.5 });
                
                for(let i=0; i<defectCount; i++) {
                    const d = new THREE.Mesh(new THREE.SphereGeometry(0.25), defMat);
                    d.position.set(
                        (Math.random()-0.5)*range,
                        (Math.random()-0.5)*range,
                        (Math.random()-0.5)*range
                    );
                    scene.add(d);
                    objects.defects.push(d);
                }
            }

            objects.moleculeGroup = group;
            scene.add(group);
        }

        // --- PLASMA SHADER SYSTEM ---
        function activatePlasma() {
            if (objects.plasmaSystem) return;

            // Custom Shader Material for Volumetric Plasma
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uColor: { value: new THREE.Color(COLORS.plasmaCore) }
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vNormal;
                    void main() {
                        vUv = uv;
                        vNormal = normalize(normalMatrix * normal);
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float uTime;
                    uniform vec3 uColor;
                    varying vec3 vNormal;
                    void main() {
                        float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 2.0);
                        float glow = sin(uTime * 3.0) * 0.2 + 0.8;
                        gl_FragColor = vec4(uColor, intensity * glow);
                    }
                `,
                side: THREE.BackSide,
                blending: THREE.AdditiveBlending,
                transparent: true,
                depthWrite: false
            });

            const geo = new THREE.SphereGeometry(6, 32, 32);
            objects.plasmaSystem = new THREE.Mesh(geo, material);
            scene.add(objects.plasmaSystem);
        }

        // --- UI LOGIC ---
        function initUI() {
            // Tab Switching
            const tabs = document.querySelectorAll('.nav-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('.nav-btn.active').classList.remove('active');
                    tab.classList.add('active');
                    renderGrid(tab.dataset.category);
                });
            });

            // Button Logic
            document.getElementById('close-sim').onclick = closeSim;
            document.getElementById('btn-run').onclick = runSimulation;

            // Initial Render
            renderGrid('hydro');
        }

        function renderGrid(cat) {
            const grid = document.getElementById('material-grid');
            grid.innerHTML = '';
            
            const data = window.MAT_DB[cat];
            data.forEach(item => {
                const el = document.createElement('div');
                el.className = 'mat-card';
                el.innerHTML = `
                    <h3>${item.id} // ${item.name}</h3>
                    <div class="desc">${item.desc}</div>
                    <span class="badge">${item.tool}</span>
                `;
                el.onclick = () => openSim(item);
                grid.appendChild(el);
            });
        }

        function openSim(item) {
            currentItem = item;
            document.getElementById('ui-layer').style.opacity = '0';
            document.getElementById('sim-view').style.display = 'flex';
            setTimeout(() => document.getElementById('sim-view').classList.add('visible'), 50);

            // Populate Info
            document.getElementById('sim-title').textContent = item.name;
            document.getElementById('sim-tool').textContent = `TOOL: ${item.tool.toUpperCase()}`;
            document.getElementById('sim-desc').textContent = item.desc;
            document.getElementById('status-display').textContent = 'UNALIGNED';
            document.getElementById('status-display').style.color = 'var(--accent-danger)';
            document.getElementById('yield-display').textContent = '0%';
            document.getElementById('results-area').innerHTML = '';
            document.getElementById('btn-run').disabled = false;
            document.getElementById('btn-run').textContent = 'INITIATE ALIGNMENT';
            document.getElementById('console-log').textContent = `>> LOADING PROTOCOL ${item.id}...\n>> READY.`;

            // Reset 3D
            generateScene(item, 'before');
            onResize();
        }

        function closeSim() {
            document.getElementById('sim-view').classList.remove('visible');
            setTimeout(() => {
                document.getElementById('sim-view').style.display = 'none';
                document.getElementById('ui-layer').style.opacity = '1';
                clearScene(); // Save GPU
            }, 500);
        }

        function runSimulation() {
            if (isSimulating) return;
            isSimulating = true;
            document.getElementById('btn-run').disabled = true;
            document.getElementById('btn-run').textContent = 'PROCESSING...';
            document.getElementById('loader').classList.add('active');

            const log = document.getElementById('console-log');
            log.textContent = '';
            
            activatePlasma();
            controls.autoRotateSpeed = 10.0; // Spin fast!

            const steps = currentItem.process;
            let stepIdx = 0;

            const interval = setInterval(() => {
                if (stepIdx < steps.length) {
                    log.textContent += `>> EXEC: ${steps[stepIdx]}\n`;
                    log.scrollTop = log.scrollHeight;
                    stepIdx++;
                } else {
                    clearInterval(interval);
                    finalizeSim();
                }
            }, 1200);
        }

        function finalizeSim() {
            isSimulating = false;
            document.getElementById('loader').classList.remove('active');
            controls.autoRotateSpeed = 2.0;

            // Update Scene to Perfect State
            generateScene(currentItem, 'after');

            // Update UI
            document.getElementById('status-display').textContent = 'PERFECTED';
            document.getElementById('status-display').style.color = 'var(--accent-secondary)';
            document.getElementById('yield-display').textContent = '99.9%';
            document.getElementById('btn-run').textContent = 'PROCESS COMPLETE';
            document.getElementById('console-log').textContent += '\n>> ALIGNMENT CONFIRMED.\n>> BATCH LOGGED.';

            // Render Table
            let html = `<table class="results-table"><thead><tr><th>METRIC</th><th>CONVENTIONAL</th><th>PROTODYNAMICS</th></tr></thead><tbody>`;
            
            Object.keys(currentItem.before).forEach(k => {
                const label = k.toUpperCase();
                html += `<tr>
                    <td>${label}</td>
                    <td class="val-bad">${currentItem.before[k]}</td>
                    <td class="val-good">${currentItem.after[k]}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('results-area').innerHTML = html;
        }

        function onResize() {
            if (!camera || !renderer) return;
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // START
        initApp();
    </script>
